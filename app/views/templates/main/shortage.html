<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼ºæ–™åˆ†æ - å”é´»å·¥æ¥­</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .shortage-container {
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card.shortage {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.sufficient {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 1;
            color: #ffffff;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: #333;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .shortage-table-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .shortage-table {
            width: 100%;
            border-collapse: collapse;
        }

        .shortage-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .shortage-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .shortage-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .shortage-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .shortage-table td {
            padding: 1rem;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-shortage {
            background-color: #fee;
            color: #c00;
        }

        .status-sufficient {
            background-color: #efe;
            color: #0a0;
        }

        .status-exact {
            background-color: #fef;
            color: #909;
        }

        .part-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .export-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
        <header class="header">
            <div class="header-left">
                <div class="logo-area">
                    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="å”é´»" class="company-logo"
                        onerror="this.style.display='none'">
                </div>
                <h1>å”é´»å·¥æ¥­ åŠ å·¥é‘„ä»¶çœ‹æ¿ç³»çµ±</h1>
                <nav class="main-nav">
                    <a href="{{ url_for('main.index') }}" class="nav-link">åº«å­˜çœ‹æ¿</a>
                    <a href="{{ url_for('main.orders_page') }}" class="nav-link">å·¥å–®éœ€æ±‚</a>
                    <a href="{{ url_for('main.shortage_page') }}" class="nav-link active">ç¼ºæ–™åˆ†æ</a>
                </nav>
            </div>
            <div class="header-right">
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('auth.profile') }}" class="lang-btn">âš™ï¸ å€‹äººè³‡æ–™</a>
                {% if current_user.is_admin() %}
                <a href="{{ url_for('auth.admin_dashboard') }}" class="lang-btn" style="margin-left: 0.5rem;">ğŸ‘¤ ç®¡ç†å“¡</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="lang-btn" style="margin-left: 0.5rem;">ç™»å‡º</a>
                {% else %}
                <a href="{{ url_for('auth.login') }}" class="lang-btn">ç™»å…¥</a>
                {% endif %}
                <div class="update-info">
                    <span class="status-dot"></span>
                    <span id="lastUpdate">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="shortage-container">
            <h2 style="margin-bottom: 1.5rem; color: #333;">ğŸ“Š ç¼ºæ–™åˆ†æ</h2>

            <!-- åº«å­˜ç¸½è¦½å¡ç‰‡ -->
            <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.1rem;">ğŸ“¦ é‘„ä»¶åº«å­˜ç¸½è¦½</h3>
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="background: white; border: 2px solid #e0e0e0; color: #333;">
                    <div class="stat-label" style="color: #666;">
                        <span class="part-icon">ğŸ”³</span>å·¥ä½œå°
                    </div>
                    <div class="stat-value" id="stockWorktable" style="color: #0088cc;">-</div>
                </div>
                <div class="stat-card" style="background: white; border: 2px solid #e0e0e0; color: #333;">
                    <div class="stat-label" style="color: #666;">
                        <span class="part-icon">ğŸ”²</span>åº•åº§
                    </div>
                    <div class="stat-value" id="stockBase" style="color: #0088cc;">-</div>
                </div>
                <div class="stat-card" style="background: white; border: 2px solid #e0e0e0; color: #333;">
                    <div class="stat-label" style="color: #666;">
                        <span class="part-icon">ğŸ“</span>æ©«æ¨‘
                    </div>
                    <div class="stat-value" id="stockCrossbeam" style="color: #0088cc;">-</div>
                </div>
                <div class="stat-card" style="background: white; border: 2px solid #e0e0e0; color: #333;">
                    <div class="stat-label" style="color: #666;">
                        <span class="part-icon">ğŸ›ï¸</span>ç«‹æŸ±
                    </div>
                    <div class="stat-value" id="stockColumn" style="color: #0088cc;">-</div>
                </div>
            </div>

            <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.1rem;">ğŸ“Š ç¼ºæ–™çµ±è¨ˆ</h3>
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">ç¸½è¨˜éŒ„æ•¸</div>
                    <div class="stat-value" id="totalRecords">-</div>
                </div>
                <div class="stat-card shortage">
                    <div class="stat-label">ç¼ºæ–™é …ç›®</div>
                    <div class="stat-value" id="shortageCount">-</div>
                </div>
                <div class="stat-card sufficient">
                    <div class="stat-label">å……è¶³é …ç›®</div>
                    <div class="stat-value" id="sufficientCount">-</div>
                </div>
            </div>

            <!-- ç¯©é¸å™¨ -->
            <div class="filters">
                <div class="filter-group">
                    <label>é›¶ä»¶é¡å‹ï¼š</label>
                    <select id="filterPartType">
                        <option value="">å…¨éƒ¨</option>
                        <option value="å·¥ä½œå°">å·¥ä½œå°</option>
                        <option value="åº•åº§">åº•åº§</option>
                        <option value="æ©«æ¨‘">æ©«æ¨‘</option>
                        <option value="ç«‹æŸ±">ç«‹æŸ±</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ç‹€æ…‹ï¼š</label>
                    <select id="filterStatus">
                        <option value="">å…¨éƒ¨</option>
                        <option value="ç¼ºæ–™" selected>ç¼ºæ–™</option>
                        <option value="å……è¶³">å……è¶³</option>
                        <option value="å‰›å¥½">å‰›å¥½</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æœå°‹ï¼š</label>
                    <input type="text" id="searchInput" placeholder="å·¥å–®è™Ÿç¢¼ã€å®¢æˆ¶ã€å“è™Ÿ...">
                </div>
                <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
            </div>

            <!-- è³‡æ–™è¡¨ -->
            <div class="shortage-table-wrapper">
                <table class="shortage-table">
                    <thead>
                        <tr>
                            <th>å·¥å–®è™Ÿç¢¼</th>
                            <th>å®¢æˆ¶åç¨±</th>
                            <th>ç”Ÿç”¢é–‹å§‹</th>
                            <th>ç”Ÿç”¢çµæŸ</th>
                            <th>å“è™Ÿ</th>
                            <th>ç‰©æ–™èªªæ˜</th>
                            <th>é›¶ä»¶é¡å‹</th>
                            <th>éœ€æ±‚æ•¸é‡</th>
                            <th>å·²é ˜æ–™</th>
                            <th>ç›®å‰ç¼ºæ–™</th>
                            <th>ç¾æœ‰åº«å­˜</th>
                            <th>ç¼ºæ–™æ•¸é‡</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="shortageTableBody">
                        <tr>
                            <td colspan="13" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        let allData = [];
        // Removed partIcons object as it is no longer needed

        // è¼‰å…¥è³‡æ–™
        async function loadShortageData() {
            try {
                const response = await fetch('/api/shortage');
                const result = await response.json();

                if (result.success) {
                    allData = result.data;

                    // å‰ç«¯å¼·åˆ¶æ’åºï¼šç”Ÿç”¢é–‹å§‹æ—¥æœŸæœ€æ—©çš„æ’æœ€ä¸Šé¢
                    allData.sort((a, b) => {
                        // è™•ç†æ—¥æœŸæ ¼å¼ï¼Œå¦‚æœæ˜¯ null å‰‡æ’åˆ°æœ€å¾Œ
                        const dateA = a.ç”Ÿç”¢é–‹å§‹ ? new Date(a.ç”Ÿç”¢é–‹å§‹) : new Date('9999-12-31');
                        const dateB = b.ç”Ÿç”¢é–‹å§‹ ? new Date(b.ç”Ÿç”¢é–‹å§‹) : new Date('9999-12-31');

                        // æ—¥æœŸå‡åº (æœ€æ—©çš„åœ¨å‰é¢)
                        if (dateA < dateB) return -1;
                        if (dateA > dateB) return 1;

                        // æ—¥æœŸç›¸åŒï¼Œå‰‡ç¼ºæ–™æ•¸é‡å¤šçš„æ’å‰é¢
                        return b.ç¼ºæ–™æ•¸é‡ - a.ç¼ºæ–™æ•¸é‡;
                    });

                    updateStats(result.stats);
                    // åˆå§‹è¼‰å…¥æ™‚ç›´æ¥å¥—ç”¨ç¯©é¸ (é è¨­å·²é¸ä¸­å°æ–¼0çš„)
                    filterData();
                    document.getElementById('lastUpdate').textContent = `æ›´æ–°æ™‚é–“: ${result.timestamp}`;
                } else {
                    showError(result.error);
                }
            } catch (error) {
                showError('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°çµ±è¨ˆå¡ç‰‡
        function updateStats(stats) {
            document.getElementById('totalRecords').textContent = stats.total_records;
            document.getElementById('shortageCount').textContent = stats.shortage_count;
            document.getElementById('sufficientCount').textContent = stats.sufficient_count;

            // æ›´æ–°åº«å­˜ç¸½è¦½
            if (stats.inventory_summary) {
                document.getElementById('stockWorktable').textContent = stats.inventory_summary['å·¥ä½œå°'] || 0;
                document.getElementById('stockBase').textContent = stats.inventory_summary['åº•åº§'] || 0;
                document.getElementById('stockCrossbeam').textContent = stats.inventory_summary['æ©«æ¨‘'] || 0;
                document.getElementById('stockColumn').textContent = stats.inventory_summary['ç«‹æŸ±'] || 0;
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('shortageTableBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="no-data">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.å·¥å–®è™Ÿç¢¼}</td>
                    <td>${item.å®¢æˆ¶åç¨±}</td>
                    <td>${formatDate(item.ç”Ÿç”¢é–‹å§‹)}</td>
                    <td>${formatDate(item.ç”Ÿç”¢çµæŸ)}</td>
                    <td><code>${item.å“è™Ÿ}</code></td>
                    <td>${item.ç‰©æ–™èªªæ˜}</td>
                    <td>${item.é›¶ä»¶é¡å‹}</td>
                    <td>${item.éœ€æ±‚æ•¸é‡}</td>
                    <td>${item.å·²é ˜æ–™}</td>
                    <td><strong>${item.ç›®å‰ç¼ºæ–™}</strong></td>
                    <td>${item.ç¾æœ‰åº«å­˜}</td>
                    <td><strong style="color: ${item.ç¼ºæ–™æ•¸é‡ > 0 ? '#c00' : '#0a0'}">${item.ç¼ºæ–™æ•¸é‡}</strong></td>
                    <td><span class="status-badge status-${item.ç‹€æ…‹ === 'ç¼ºæ–™' ? 'shortage' : item.ç‹€æ…‹ === 'å……è¶³' ? 'sufficient' : 'exact'}">${item.ç‹€æ…‹}</span></td>
                </tr>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW');
        }

        // ç¯©é¸è³‡æ–™
        function filterData() {
            const partType = document.getElementById('filterPartType').value;
            const status = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allData;

            if (partType) {
                filtered = filtered.filter(item => item.é›¶ä»¶é¡å‹ === partType);
            }

            if (status) {
                filtered = filtered.filter(item => item.ç‹€æ…‹ === status);
            }

            if (search) {
                filtered = filtered.filter(item =>
                    item.å·¥å–®è™Ÿç¢¼.toLowerCase().includes(search) ||
                    item.å®¢æˆ¶åç¨±.toLowerCase().includes(search) ||
                    item.å“è™Ÿ.toLowerCase().includes(search) ||
                    item.ç‰©æ–™èªªæ˜.toLowerCase().includes(search)
                );
            }

            renderTable(filtered);
        }

        // åŒ¯å‡º Excel
        function exportToExcel() {
            window.location.href = '/api/shortage/export';
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            const tbody = document.getElementById('shortageTableBody');
            tbody.innerHTML = `<tr><td colspan="13" class="no-data" style="color: #c00;">éŒ¯èª¤: ${message}</td></tr>`;
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('filterPartType').addEventListener('change', filterData);
        document.getElementById('filterStatus').addEventListener('change', filterData);
        document.getElementById('searchInput').addEventListener('input', filterData);

        // åˆå§‹è¼‰å…¥
        loadShortageData();

        // æ¯30ç§’è‡ªå‹•æ›´æ–°
        setInterval(loadShortageData, 30000);
    </script>
</body>

</html>